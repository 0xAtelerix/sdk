# Block Explorer API Guide

## Overview

This guide explains how to use the Atelerix SDK Block Explorer RPC API to build block explorers and blockchain analytics tools. The API is **generic** and works with any appchain, regardless of their custom Block, Transaction, or Receipt structures.

## Key Features

✅ **Generic JSON responses** - Works with any appchain's custom types
✅ **JSON Schema discovery** - Automatically discover field structures
✅ **Type-safe** - Numbers stay numbers, booleans stay booleans
✅ **Standard format** - Compatible with all JSON tools

---

## Available RPC Methods

### 1. `getAppchainSchema` - Discover Field Structure

**Purpose**: Get JSON Schema description of Block, Transaction, and Receipt types

**Parameters**: None

**Returns**:
```json
{
  "chainId": 42,
  "version": "1.0.0",
  "schemas": {
    "block": { /* JSON Schema */ },
    "transaction": { /* JSON Schema */ },
    "receipt": { /* JSON Schema */ }
  }
}
```

**Example Request**:
```bash
curl -X POST http://localhost:8080 \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "getAppchainSchema",
    "params": [],
    "id": 1
  }'
```

**Example Response** (Orderbook Appchain):
```json
{
  "jsonrpc": "2.0",
  "result": {
    "chainId": 42,
    "version": "1.0.0",
    "schemas": {
      "transaction": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "type": "object",
        "title": "Transaction",
        "properties": {
          "type": {"type": "string"},
          "sender": {"type": "string"},
          "value": {"type": "integer", "minimum": 0},
          "pair": {"type": "string"},
          "side": {"type": "string"},
          "price": {"type": "number"},
          "quantity": {"type": "number"},
          "signature": {"type": "string", "pattern": "^0x[a-fA-F0-9]+$"}
        },
        "required": ["type", "sender", "value", "signature"]
      }
    }
  },
  "id": 1
}
```

---

### 2. `getBlock` - Get Single Block

**Purpose**: Retrieve block details by block number

**Parameters**: `[blockNumber]`

**Example**:
```javascript
{
  "jsonrpc": "2.0",
  "method": "getBlock",
  "params": [42],
  "id": 1
}
```

**Response** (Orderbook Appchain):
```json
{
  "jsonrpc": "2.0",
  "result": {
    "number": 42,
    "root": "0x1234...",
    "transactions": [
      {
        "chainID": 1,
        "payload": "0x..."
      }
    ]
  },
  "id": 1
}
```

**Response** (Example Appchain):
```json
{
  "jsonrpc": "2.0",
  "result": {
    "number": 0,
    "hash": "0x0000...",
    "stateRoot": "0x0000...",
    "bytes": ""
  },
  "id": 1
}
```

> **Note**: Different appchains return different fields! Use `getAppchainSchema` to discover what fields are available.

---

### 3. `getTransactionsByBlockNumber` - Get Block Transactions

**Purpose**: Retrieve all transactions in a specific block

**Parameters**: `[blockNumber]`

**Example**:
```javascript
{
  "jsonrpc": "2.0",
  "method": "getTransactionsByBlockNumber",
  "params": [42],
  "id": 1
}
```

**Response** (Orderbook Appchain):
```json
{
  "jsonrpc": "2.0",
  "result": [
    {
      "type": "place_limit_order",
      "sender": "0xabc...",
      "value": 1000,
      "pair": "ETH/USDC",
      "side": "buy",
      "price": 2000.50,
      "quantity": 0.5,
      "hash": "0xdef...",
      "signature": "0x..."
    },
    {
      "type": "place_market_order",
      "sender": "0x123...",
      "value": 500,
      "pair": "ETH/USDC",
      "side": "sell",
      "quantity": 0.25,
      "hash": "0x456...",
      "signature": "0x..."
    }
  ],
  "id": 1
}
```

**Response** (Example Appchain):
```json
{
  "jsonrpc": "2.0",
  "result": [
    {
      "sender": "alice",
      "value": 100
    },
    {
      "sender": "bob",
      "value": 200
    }
  ],
  "id": 1
}
```

---

### 4. `getTransaction` - Get Single Transaction

**Purpose**: Retrieve transaction details by hash

**Parameters**: `[txHash]`

**Example**:
```javascript
{
  "jsonrpc": "2.0",
  "method": "getTransaction",
  "params": ["0x1234567890abcdef..."],
  "id": 1
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "result": {
    "type": "place_limit_order",
    "sender": "0xabc...",
    "pair": "ETH/USDC",
    "price": 2000.50,
    "quantity": 0.5,
    /* ... all transaction fields */
  },
  "id": 1
}
```

---

### 5. `getExternalTransactions` - Get External Transactions

**Purpose**: Retrieve cross-chain transactions generated by a block

**Parameters**: `[blockNumber]`

**Example**:
```javascript
{
  "jsonrpc": "2.0",
  "method": "getExternalTransactions",
  "params": [42],
  "id": 1
}
```

**Response**:
```json
{
  "jsonrpc": "2.0",
  "result": [
    {
      "chainID": 1,
      "payload": "0x..."
    },
    {
      "chainID": 5656,
      "payload": "0x..."
    }
  ],
  "id": 1
}
```

---

### 6. Existing Methods

The API also includes standard transaction and receipt methods:

- `sendTransaction` - Submit a transaction
- `getTransactionStatus` - Check transaction status
- `getTransactionReceipt` - Get transaction receipt
- `getPendingTransactions` - List pending transactions

See the [RPC README](./gosdk/rpc/README.md) for details on these methods.

---

## Frontend Integration

### Option 1: Generic Explorer (No Schema Required)

Build a completely generic explorer that works with **any** appchain without knowing the schema in advance:

```typescript
// Generic block explorer component
interface AppchainData {
  [key: string]: any;
}

function GenericBlockExplorer() {
  const [block, setBlock] = useState<AppchainData | null>(null);

  async function loadBlock(blockNumber: number) {
    const response = await rpcCall("getBlock", [blockNumber]);
    setBlock(response.result);
  }

  return (
    <div>
      <h2>Block Details</h2>
      {block && (
        <div>
          {/* Automatically display all fields */}
          {Object.entries(block).map(([key, value]) => (
            <div key={key}>
              <strong>{key}:</strong> {formatValue(value)}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

function formatValue(value: any): string {
  if (typeof value === 'number') {
    return value.toLocaleString();
  }
  if (typeof value === 'boolean') {
    return value ? '✓' : '✗';
  }
  if (Array.isArray(value)) {
    return `[${value.length} items]`;
  }
  if (typeof value === 'object') {
    return JSON.stringify(value, null, 2);
  }
  return String(value);
}
```

### Option 2: Schema-Aware Explorer (Better UX)

Use the schema to build smarter UIs:

```typescript
interface AppchainSchema {
  chainId: number;
  version: string;
  schemas: {
    block: JSONSchema;
    transaction: JSONSchema;
    receipt: JSONSchema;
  };
}

// Load schema once on app startup
const schema = await rpcCall("getAppchainSchema", []);

// Check what type of appchain this is
const txProperties = schema.schemas.transaction.properties;

if ('pair' in txProperties && 'price' in txProperties) {
  // This is a trading appchain!
  return <TradingExplorer />;
} else if ('gameId' in txProperties) {
  // This is a gaming appchain!
  return <GamingExplorer />;
} else {
  // Unknown appchain - use generic view
  return <GenericExplorer />;
}
```

### Option 3: Auto-Generate TypeScript Types

Use tools to generate types from JSON Schema:

```bash
# Install quicktype
npm install -g quicktype

# Fetch schema from your appchain
curl http://localhost:8080 \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"getAppchainSchema","params":[],"id":1}' \
  | jq '.result.schemas.transaction' > transaction-schema.json

# Generate TypeScript types
quicktype transaction-schema.json -o types.ts
```

**Generated `types.ts`**:
```typescript
export interface Transaction {
    type:      string;
    sender:    string;
    value:     number;
    pair:      string;
    side:      string;
    price:     number;
    quantity:  number;
    signature: string;
}

// Now you have full type safety!
const tx: Transaction = await rpcCall("getTransaction", [hash]);
console.log(tx.price.toFixed(2)); // ✅ TypeScript knows price is a number
```

---

## Complete Explorer Example

Here's a full example React app:

```typescript
import React, { useState, useEffect } from 'react';

// RPC helper
async function rpcCall(method: string, params: any[]) {
  const response = await fetch('http://localhost:8080', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      jsonrpc: '2.0',
      method,
      params,
      id: Date.now(),
    }),
  });
  const data = await response.json();
  if (data.error) throw new Error(data.error.message);
  return data.result;
}

function BlockExplorer() {
  const [schema, setSchema] = useState(null);
  const [blocks, setBlocks] = useState([]);
  const [selectedBlock, setSelectedBlock] = useState(null);
  const [transactions, setTransactions] = useState([]);

  // Load schema on mount
  useEffect(() => {
    rpcCall('getAppchainSchema', []).then(setSchema);
  }, []);

  // Load recent blocks
  useEffect(() => {
    rpcCall('getBlockRange', [0, 100]).then(result => {
      setBlocks(result.blocks);
    });
  }, []);

  // Load transactions when block is selected
  async function selectBlock(blockNumber: number) {
    setSelectedBlock(blockNumber);
    const txs = await rpcCall('getTransactionsByBlockNumber', [blockNumber]);
    setTransactions(txs);
  }

  return (
    <div className="explorer">
      <h1>Appchain Explorer</h1>

      {schema && (
        <div className="schema-info">
          <p>Chain ID: {schema.chainId}</p>
          <p>Version: {schema.version}</p>
        </div>
      )}

      <div className="blocks-list">
        <h2>Recent Blocks</h2>
        {blocks.map(block => (
          <div
            key={block.number}
            onClick={() => selectBlock(block.number)}
            className="block-item"
          >
            <strong>Block {block.number}</strong>
            {/* Display all block fields generically */}
            {Object.entries(block).map(([key, value]) => (
              <div key={key}>{key}: {formatValue(value)}</div>
            ))}
          </div>
        ))}
      </div>

      {selectedBlock !== null && (
        <div className="transactions">
          <h2>Transactions in Block {selectedBlock}</h2>
          {transactions.map((tx, idx) => (
            <div key={idx} className="transaction">
              {/* Display all transaction fields generically */}
              {Object.entries(tx).map(([key, value]) => (
                <div key={key}>
                  <strong>{key}:</strong> {formatValue(value)}
                </div>
              ))}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

function formatValue(value: any): string {
  if (typeof value === 'number') {
    return value.toLocaleString();
  }
  if (typeof value === 'boolean') {
    return value ? '✓' : '✗';
  }
  if (typeof value === 'string' && value.startsWith('0x')) {
    return value.slice(0, 10) + '...';
  }
  if (Array.isArray(value)) {
    return `[${value.length} items]`;
  }
  if (typeof value === 'object') {
    return JSON.stringify(value);
  }
  return String(value);
}

export default BlockExplorer;
```

---

## Validation with JSON Schema

Use AJV for runtime validation:

```typescript
import Ajv from 'ajv';

const ajv = new Ajv();
const schema = await rpcCall('getAppchainSchema', []);

// Compile schema
const validateTx = ajv.compile(schema.schemas.transaction);

// Fetch and validate transaction
const tx = await rpcCall('getTransaction', [hash]);

if (!validateTx(tx)) {
  console.error('Invalid transaction data:', validateTx.errors);
}
```

---

## Performance Tips

### 1. Batch Requests

The RPC server supports JSON-RPC batch requests:

```javascript
const response = await fetch('http://localhost:8080', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify([
    { jsonrpc: '2.0', method: 'getBlock', params: [1], id: 1 },
    { jsonrpc: '2.0', method: 'getBlock', params: [2], id: 2 },
    { jsonrpc: '2.0', method: 'getBlock', params: [3], id: 3 },
  ]),
});

const results = await response.json();
// Returns array of results
```

### 2. Pagination

Use the `limit` parameter in `getBlockRange`:

```javascript
// Page 1: blocks 0-99
const page1 = await rpcCall('getBlockRange', [0, 99, 100]);

// Page 2: blocks 100-199
const page2 = await rpcCall('getBlockRange', [100, 199, 100]);
```

### 3. Cache Schema

Load schema once and cache it:

```typescript
let schemaCache: AppchainSchema | null = null;

async function getSchema(): Promise<AppchainSchema> {
  if (!schemaCache) {
    schemaCache = await rpcCall('getAppchainSchema', []);
  }
  return schemaCache;
}
```

---

## Error Handling

The API returns standard JSON-RPC errors:

```json
{
  "jsonrpc": "2.0",
  "error": {
    "code": -32600,
    "message": "block not found"
  },
  "id": 1
}
```

**Common error codes**:
- `-32600`: Invalid request
- `-32601`: Method not found
- `-32602`: Invalid params
- `-32603`: Internal error

**Handle errors properly**:
```typescript
try {
  const block = await rpcCall('getBlock', [999999]);
} catch (error) {
  if (error.message === 'block not found') {
    console.log('Block does not exist yet');
  } else {
    console.error('RPC error:', error);
  }
}
```

---

## WebSocket Support (Coming Soon)

Real-time block and transaction updates will be available via WebSocket:

```javascript
const ws = new WebSocket('ws://localhost:8080/ws');

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);

  if (data.method === 'newBlock') {
    console.log('New block:', data.params.block);
  }

  if (data.method === 'newTransaction') {
    console.log('New transaction:', data.params.transaction);
  }
};
```

---

## Testing Your Explorer

### 1. Test with Example Appchain

The SDK includes a minimal example appchain for testing:

```bash
cd gosdk
go test -run TestExampleAppchain -v
```

### 2. Test with Orderbook Appchain

For production-like testing, use the orderbook appchain:

```bash
cd /Users/krishna/Liq-Markets/orderbook-appchain
go run main.go
```

Then test RPC calls:

```bash
# Get schema
curl -X POST http://localhost:8080 \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"getAppchainSchema","params":[],"id":1}' \
  | jq .

# Get block
curl -X POST http://localhost:8080 \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"getBlock","params":[0],"id":1}' \
  | jq .
```

---

## Summary

✅ **Use `getAppchainSchema`** to discover field structures
✅ **Build generic UIs** that work with any appchain
✅ **Generate TypeScript types** for type safety
✅ **Validate responses** with JSON Schema
✅ **Handle all field types** properly (numbers, booleans, strings)
✅ **Batch requests** for better performance

The API is designed to be **simple, standard, and universal** - one explorer codebase works with all appchains!

---

## Support

- **Documentation**: [SDK README](./Readme.md)
- **RPC Details**: [RPC README](./gosdk/rpc/README.md)
- **Issues**: [GitHub Issues](https://github.com/0xAtelerix/sdk/issues)
